{% extends "../core/document.html" %}

{% comment ******************* %}
{% comment Emit navigation     %}
{% comment ******************* %}
{% block doc-nav %}
    <li><a href="#{{ doc.ext.full_id }}-overview">Overview</a></li>
	{% if len(doc.citations) %}
	    <li><a href="#{{ doc.ext.full_id }}-citations">Citations</a></li>
    {% end %}
    {% set contacts = [rp for rp in doc.responsible_parties if rp.role.lower() not in ['funder', 'centre']] %}
	{% if len(contacts) %}
	    <li><a href="#{{ doc.ext.full_id }}-contacts">Contacts</a></li>
    {% end %}
	{% if len(doc._scientific_property_tree[0].sub_properties) %}
	    <li><a href="#{{ doc.ext.full_id }}-properties">Properties</a></li>
    {% end %}
	{% if len(doc._component_tree) %}
	    <li><a href="#{{ doc.ext.full_id }}-components" >Components</a></li>
    {% end %}
{% end %}

{% comment ***************** %}
{% comment Emit content      %}
{% comment ***************** %}
{% block doc-content %}

	{% comment ***************** %}
	{% comment Emit overview     %}
	{% comment ***************** %}
	{% set ctx = TemplateInfo(doc,
		header = "Overview",
		fieldset = [
		    FieldInfo('Project', path='meta.project'),
		    FieldInfo('Institute', path='meta.institute'),
	        FieldInfo('Name', path='short_name'),
	        FieldInfo('Long Name', path='long_name'),
	        FieldInfo('Funder', path='responsible_parties.role=funder.organisation_name', link_path='responsible_parties.role=funder.contact_info.url'),
	        FieldInfo('Principal Investigator', path='responsible_parties.role=pi.individual_name', email_path='responsible_parties.role=pi.contact_info.email'),
	        FieldInfo('Release Date', path='release_date'),
	        FieldInfo('Description', path='description'),
		],
		tag_id = doc.ext.full_id + "-overview",
		template = "fieldset_table.html"
	) %}
	{% include ../core/section_01.html %}

	{% comment **************************** %}
	{% comment Emit scientific properties   %}
	{% comment **************************** %}
	{% if len(doc._scientific_property_tree[0].sub_properties) %}
		{% set ctx = TemplateInfo(doc,
			fieldset_type = "property",
			header = "Properties",
			tag_id = doc.ext.full_id + "-properties",
			template = "fieldset_table.html"
		) %}
		{% for p in doc._scientific_property_tree %}
			{% for v in sorted(p.values) %}
				{% raw ctx.fieldset.append(FieldInfo(p._full_display_name, value=v)) or "" %}
			{% end %}
		{% end %}
		{% include ../core/section_01.html %}
	{% end %}

	{% comment ***************** %}
	{% comment Emit citations    %}
	{% comment ***************** %}
	{% set ctx = TemplateInfo(doc.citations,
		header = "Citations",
		tag_id = doc.ext.full_id + "-citations",
		template = "cim_1_shared_citation.html"
	) %}
	{% include ../core/section_01.html %}

	{% comment ***************** %}
	{% comment Emit contacts     %}
	{% comment ***************** %}
	{% set ctx = TemplateInfo([rp for rp in doc.responsible_parties if rp.role.lower() not in ['funder', 'centre']],
		header = "Contacts",
		tag_id = doc.ext.full_id + "-contacts",
		template = "cim_1_shared_responsible_party.html"
	) %}
	{% include ../core/section_01.html %}

	{% comment ***************** %}
	{% comment Emit components   %}
	{% comment ***************** %}
	{% if len(doc._component_tree) %}
		<section id="{{doc.ext.full_id + "-components"}}"
				 class="{{doc.type_key.lower().replace(".", "-")}}-components">
			<header><h3>Components</h3></header>

			{% comment ********************* %}
			{% comment Emit component tree   %}
			{% comment ********************* %}
			<nav>
				<ul class="depth-0">
				{% for c in doc.sub_components %}
					<li>
						<a id="nav-{{c.meta.id}}" href="#">{{c._short_display_name}}</a>
					</li>
					{% if len(c.sub_components) %}
						<ul class="depth-1">
							{% for c in c.sub_components %}
								<li>
									<a id="nav-{{c.meta.id}}" href="#">{{c._short_display_name}}</a>
								</li>
								{% if len(c.sub_components) %}
									<ul class="depth-2">
										{% for c in c.sub_components %}
										<li>
											<a id="nav-{{c.meta.id}}" href="#">{{c._short_display_name}}</a>
										</li>
										{% end %}
									</ul>
								{% end %}
							{% end %}
						</ul>
					{% end %}
				{% end %}
				</ul>
			</nav>

			{% comment ********************** %}
			{% comment Emit component details %}
			{% comment ********************** %}
			{% for c in doc._component_tree %}
				<section id="{{c.meta.id}}">
					<header>
						<h4>
						{% for pc in c._ancestors[1:] %}
							<span id="breadcrumb-{{pc.meta.id}}">
							{{ pc._short_display_name }} >
							</span>
						{% end %}
						{{ c._short_display_name }}
						</h4>
					</header>

					{% comment *************** %}
					{% comment ... overview   %}
					{% comment *************** %}
					{% if c.description and len(c.description) %}
					<section>
						<header><h5>Overview</h5></header>
						<p>{{ c.description }}</p>
					</section>
					{% end %}

					{% comment *************************** %}
					{% comment ... scientific properties   %}
					{% comment *************************** %}
					{% if len(c._scientific_property_tree) %}
					<section>
						<header><h5>Properties</h5></header>
						<table>
							<tbody>
								{% for p in c._scientific_property_tree %}
									{% for v in sorted(p.values) %}
									<tr class="esdoc-field">
										<td>
											<b>{{ " > ".join(p._display_name.split(" > ")[1:]) }}</b>: {{v}}
										</td>
									</tr>
									{% end %}
								{% end %}
							</tbody>
						</table>
					</section>
				    {% end %}

					{% comment *************** %}
					{% comment ... citations   %}
					{% comment *************** %}
					{% if len(c.citations) %}
						{% set ctx = TemplateInfo(c.citations,
							depth = 2,
							header = "Citations",
							template = "cim_1_shared_citation.html",
							previous = ctx
						) %}
						{% include ../core/section_01.html %}
						{% set ctx = ctx.previous %}
					{% end %}

					{% comment **************** %}
					{% comment ... contacts     %}
					{% comment **************** %}
				    {% set contacts = [rp for rp in c.responsible_parties if rp.role.lower() not in ['funder', 'centre']] %}
					{% if len(contacts) %}
						{% set ctx = TemplateInfo(contacts,
							depth = 2,
							header = "Contacts",
							template = "cim_1_shared_responsible_party.html",
							previous = ctx
						) %}
						{% include ../core/section_01.html %}
						{% set ctx = ctx.previous %}
				    {% end %}

				</section>
			{% end %}
		</section>
    {% end %}

{% end %}